## 购物商城项目：

类似于京东淘宝：

用户进入购物商城，首先是一个商品列表页，点击某一件商品可以查看商品详情，展示商品信息

当用户点击“加入购物车”或者“立即购买”时，系统校验用户是否登录，登陆过可继续操作，未登录则进入登录界面进行登录；

点击加入购物车，可更改商品数量并跳转到购物车界面，购物车界面可查看商品信息，已加购的数量、价格、数量可更改

点击购买进入订单填写页面，确认收货人、收货地址、商品信息，确认无误点击支付

点击支付后后端会进行生成订单和调用支付接口操作

支付完成前订单状态时未支付，超过30分钟未支付则会更改订单状态为已取消

支付完成后订单状态被改为已支付或等待发货，跳转到前端支付状态确认界面，确认完成跳转订单列表界面

该界面可查看订单信息，包括编号，总价格等，点击查看详情可查看订单具体信息，什么商品数量购买时的成交价以及购买人的信息

##### 关键、注意的点：

1.加购使用的redis实现,用户id商品id分别为key，更改数量使用redis自带的increment方法

2.订单重复提交后端生成一个随机字符串A和提前约定好的B拼接加密生成C,将C存到redis中，将A发送给前端；前端将A和约定好的B拼接，进行加密，再去redis中判断是否存在并删去；这样重复提交的时候就会删除失败，防止重复提交；

3.扣库存，使用一条update语句 库存数-购买数量  where中判断库存数是否大于等于购买数量



### 支付网关

##### 支付宝：

网关收到商城那边传过来的数据，将传过来的回调地址存起来，将其余传过来的数据和网关的回调地址存到一个treemap中，按字典顺序排序；

将排好序的集合拼成一个字符串，通过RSA2方式用支付宝私钥将其加密，将加密后的数据和其他数据拼接到form表单中发送给前端；表单会自动提交，成功支付后支付宝会调网关的回调接口，并发送订单信息，网管接收后存到数据库中，然后调用商城的修改订单状态的接口，将订单状态修改成已支付；

##### 微信：

网关收到商城那边传过来的数据，将传过来的回调地址存起来，将其余传过来的数据和网关的回调地址存到一个treemap中，按字典顺序排序；

将排好序的集合在拼成一个字符串，通过MD5方式和微信密钥拼接加密生成一个新字符串sign，也放到treemap中；

将最终的treemap转成XML通过restTemplate发送给微信，微信会返回一个字符串，网关将字符串中的mweb_url拼接上redirect_url返回给前端界面；

前端界面打开这个url完成支付后，微信调网关回调接口，发送订单信息，网管接收后存到数据库中，然后调用商城的修改订单状态的接口，将订单状态修改成已支付；

### 充值

进入充值页面，可以看到自己余额，点击充值按钮，可以填写金额，点击支付后端会拉起支付接口，生成充值订单，状态未完成；

支付完成后，网管回调充值的回调接口，先更改充值订单的状态，更改成功后更改用户余额，将查询出来的用户余额填到充值订单的余额中；最后支付宝跳转到充值前端的定时器界面，每两秒查询一次订单状态如是已完成则返回查看余额界面

###### 注意

更改用户余额时采用加等

### 单点登录

流程：用户在浏览器访问项目A，项目A后台校验token，因为此时未登录所以校验token未通过，会跳转到sso登录验证；

此时sso也是没有token的，所以会跳转到前端登录页面，用户输入用户名密码，sso验证通过会生成自己的token和一个ticket，并将ticket发送到来时的前端页面，也就是A的前端；

A的前端会先判断url中是否包含ticket，将其分割出来，发送给后端，后端拦截器校验ticket的真实性，验证通过生成A的token,生成token的A项目就可以访问了；

此时，去访问B项目，B项目校验token未通过，会跳转到sso，此时的sso已有token，会生成一个ticket返回给B；

B的前端会先判断url中是否包含ticket，将其分割出来，发送给后端，后端拦截器校验ticket的真实性，验证通过生成B的token,生成token的B项目就可以访问了；



## **权限管理模块**

不同的用户登录系统看到的菜单不同，只能看到自己拥有权限的菜单，只能进行自己有权限的操作。

###### 数据库表设计

用户登录就必须要有**用户表**，每个用户都应该有对应的角色以便进行权限的管理，所以还要有**角色表**。用户表和角色表为多对一的关系，一个角色可以有多个用户，一个用户只能有一个角色。

不同用户登录看到不同的菜单，所以还需要**菜单表**，角色与菜单应为多对多的关系，一个角色可以有多个菜单，一个菜单也可以被多个角色拥有，因此菜单表与角色表还应有一个**中间表**。菜单应分为多级菜单，二级菜单及以下有动作url，即（增删改查）。因此还需要**动作表**，动作表分为普通动作和授权动作，普通动作时维持页面正常运行。菜单与动作之间为一对多的关系，一个菜单有多个动作。

**角色与动作之间为多对多的关系**，一个角色可以有多个动作，一个动作也可以被多个角色拥有，因此角色表和动作表之间也应有一个**中间表**。

普通动作、



动作通过页面添加



总共需要六个表

主要功能为菜单管理、角色管理、权限管理

菜单管理实现：不同用户登录后，后台根据该用户对应的角色查出其拥有权限的菜单返回个前端进行动态路由添加。

角色管理：角色表增删改查

权限管理：用户登录后，将之对应角色的普通动作和授权动作查询出来。后台将该角色拥有的权限发一份给前端，存一份在redis中，在过滤器中将redis中保存的权限列表取出，根据角色拥有的权限对接口进行拦截。普通动作在权限树中默认选中且不能更改，授权动作可以进行勾选赋权。

前端按钮根据权限表的url来判断显示与隐藏。











